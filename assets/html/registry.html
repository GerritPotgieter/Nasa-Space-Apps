<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>THE ORB - Satellite Registry</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: #121212;
        color: #eaeaea;
        line-height: 1.6;
        overflow-x: hidden;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
      }

      /* Header Styles */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(234, 234, 234, 0.15);
      }

      .nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
      }

      .logo {
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: 0.2em;
        color: #eaeaea;
      }

      .nav-menu {
        display: flex;
        list-style: none;
        gap: 3rem;
      }

      .nav-link {
        color: #eaeaea;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        transition: color 0.3s ease;
      }

      .nav-link:hover,
      .nav-link.active {
        color: #e85d04;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b35, #ff8c42);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
      }

      .main {
        padding-top: 70px;
        min-height: 100vh;
      }

      /* Registry Section */
      .registry-section {
        padding: 4rem 0;
        background: #121212;
      }

      .section-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem 0;
      }

      .section-header h2 {
        font-family: "Playfair Display", serif;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        color: #eaeaea;
      }

      .section-header p {
        color: #eaeaea;
        font-size: 1rem;
        opacity: 0.8;
      }

      .table-container {
        background: rgba(18, 18, 18, 0.3);
        border: 1px solid rgba(234, 234, 234, 0.15);
        border-radius: 12px;
        overflow: hidden;
        backdrop-filter: blur(20px);
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(234, 234, 234, 0.15);
      }

      .table-header h3 {
        font-size: 1.3rem;
        color: #e85d04;
      }

      .search-input {
        padding: 0.75rem 1.5rem;
        background: rgba(18, 18, 18, 0.5);
        border: 1px solid rgba(234, 234, 234, 0.15);
        border-radius: 25px;
        color: #eaeaea;
        font-size: 0.9rem;
        width: 300px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #e85d04;
        background: rgba(18, 18, 18, 0.7);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table thead {
        background: rgba(18, 18, 18, 0.5);
      }

      .data-table th {
        padding: 1rem 1.5rem;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        color: #e85d04;
        border-bottom: 1px solid rgba(234, 234, 234, 0.15);
      }

      .data-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(234, 234, 234, 0.08);
        color: #eaeaea;
        opacity: 0.9;
      }

      .data-table tbody tr {
        transition: all 0.3s ease;
      }

      .data-table tbody tr:hover {
        background: rgba(232, 93, 4, 0.05);
      }

      .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: inline-block;
      }

      .status-active {
        background: rgba(46, 213, 115, 0.2);
        color: #2ed573;
      }

      .status-inactive {
        background: rgba(232, 93, 4, 0.2);
        color: #e85d04;
      }

      .status-deorbited {
        background: rgba(255, 71, 87, 0.2);
        color: #ff4757;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: #eaeaea;
        opacity: 0.7;
      }

      .filter-bar {
        padding: 1rem 2rem;
        background: rgba(18, 18, 18, 0.5);
        border-bottom: 1px solid rgba(234, 234, 234, 0.15);
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        backdrop-filter: blur(10px);
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-label {
        color: #eaeaea;
        opacity: 0.7;
        font-size: 0.85rem;
        margin-right: 0.5rem;
        white-space: nowrap;
      }

      .filter-button {
        padding: 0.5rem 1rem;
        background: rgba(18, 18, 18, 0.7);
        border: 1px solid rgba(234, 234, 234, 0.15);
        border-radius: 6px;
        color: #eaeaea;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .filter-button.active,
      .filter-button:hover {
        background: #e85d04;
        border-color: #e85d04;
        color: #121212;
        transform: translateY(-1px);
      }

      .filter-select {
        padding: 0.5rem 1rem;
        background: rgba(18, 18, 18, 0.7);
        border: 1px solid rgba(234, 234, 234, 0.15);
        border-radius: 6px;
        color: #eaeaea;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-select:focus {
        outline: none;
        border-color: #e85d04;
        background: rgba(18, 18, 18, 0.9);
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid rgba(234, 234, 234, 0.15);
      }

      .pagination-button {
        padding: 0.5rem 1rem;
        background: rgba(18, 18, 18, 0.7);
        border: 1px solid rgba(234, 234, 234, 0.15);
        border-radius: 6px;
        color: #eaeaea;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .pagination-button:hover:not(:disabled) {
        background: #e85d04;
        border-color: #e85d04;
        color: #121212;
        transform: translateY(-1px);
      }

      .pagination-button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .pagination-info {
        color: #eaeaea;
        opacity: 0.7;
        font-size: 0.85rem;
      }

      .stats-row {
        display: flex;
        gap: 2rem;
        padding: 1rem 2rem;
        background: rgba(18, 18, 18, 0.5);
        border-bottom: 1px solid rgba(234, 234, 234, 0.15);
        backdrop-filter: blur(10px);
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .stat-label {
        color: #eaeaea;
        opacity: 0.7;
        font-size: 0.85rem;
      }

      .stat-value {
        color: #e85d04;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* Table Row Click Effect */
      .data-table tbody tr {
        cursor: pointer;
      }

      /* Comprehensive Detail Modal Styles */
      .detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 3000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        overflow-y: auto;
      }

      .detail-modal.active {
        opacity: 1;
        pointer-events: all;
      }

      .detail-modal-content {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        background: rgba(18, 18, 18, 0.95);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .detail-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e85d04;
      }

      .detail-modal-header h2 {
        font-size: 2rem;
        color: #e85d04;
        margin: 0;
      }

      .detail-modal-close {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.5rem;
        transition: background 0.3s ease;
      }

      .detail-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .detail-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
      }

      .detail-section {
        background: rgba(255, 255, 255, 0.03);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .detail-section h3 {
        color: #e85d04;
        font-size: 1.2rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .detail-row:last-child {
        border-bottom: none;
      }

      .detail-row-label {
        color: #888;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .detail-row-value {
        color: #fff;
        font-weight: 600;
        text-align: right;
        font-size: 0.9rem;
        word-break: break-word;
        max-width: 60%;
      }

      .tle-section {
        grid-column: 1 / -1;
        background: rgba(232, 93, 4, 0.05);
        border-color: rgba(232, 93, 4, 0.3);
      }

      .tle-line {
        background: rgba(0, 0, 0, 0.5);
        padding: 0.75rem;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        color: #0f0;
        margin: 0.5rem 0;
        overflow-x: auto;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <nav class="nav">
        <a href="dashboard.html" class="logo">THE ORB</a>
        <ul class="nav-menu">
          <li><a href="tracker_v2.html" class="nav-link">Tracker</a></li>
          <li><a href="registry.html" class="nav-link active">Registry</a></li>
          <li><a href="tools.html" class="nav-link">Tools</a></li>
        </ul>
        <div class="user-profile">
          <div class="user-avatar">SA</div>
        </div>
      </nav>
    </header>

    <main class="main">
      <section class="registry-section">
        <div class="container">
          <div class="section-header">
            <h2>Satellite Registry</h2>
            <p>
              Complete database of 65,880+ satellites with filtering and search
              capabilities
            </p>
          </div>

          <div class="table-container">
            <div class="table-header">
              <h3>Satellites (<span id="satelliteCount">0</span>)</h3>
              <input
                type="text"
                class="search-input"
                placeholder="Search by name, NORAD ID, or owner..."
                id="registrySearch"
              />
            </div>

            <div class="stats-row">
              <div class="stat-item">
                <span class="stat-label">Total:</span>
                <span class="stat-value" id="totalCount">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Active:</span>
                <span class="stat-value" id="activeCount">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Inactive:</span>
                <span class="stat-value" id="inactiveCount">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Showing:</span>
                <span class="stat-value" id="showingCount">0</span>
              </div>
            </div>

            <div class="filter-bar">
              <div class="filter-group">
                <span class="filter-label">Status:</span>
                <button class="filter-button active" data-status="all">
                  All
                </button>
                <button class="filter-button" data-status="ACTIVE">
                  Active
                </button>
                <button class="filter-button" data-status="INACTIVE">
                  Inactive
                </button>
              </div>

              <div class="filter-group">
                <span class="filter-label">Type:</span>
                <button class="filter-button active" data-type="all">
                  All
                </button>
                <button class="filter-button" data-type="P">Payload</button>
                <button class="filter-button" data-type="R">Rocket Body</button>
                <button class="filter-button" data-type="C">Debris</button>
              </div>

              <div class="filter-group">
                <span class="filter-label">Country:</span>
                <select class="filter-select" id="countryFilter">
                  <option value="all">All Countries</option>
                </select>
              </div>

              <div class="filter-group">
                <span class="filter-label">Organization:</span>
                <select class="filter-select" id="organizationFilter">
                  <option value="all">All Organizations</option>
                </select>
              </div>

              <div class="filter-group">
                <span class="filter-label">Sort by:</span>
                <select class="filter-select" id="sortFilter">
                  <option value="name">Name (A-Z)</option>
                  <option value="date-desc">Launch Date (Newest)</option>
                  <option value="date-asc">Launch Date (Oldest)</option>
                  <option value="norad">NORAD ID</option>
                </select>
              </div>
            </div>

            <table class="data-table" id="satelliteTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>NORAD ID</th>
                  <th>Type</th>
                  <th>Owner</th>
                  <th>Launch Date</th>
                  <th>Status</th>
                  <th>Destination</th>
                </tr>
              </thead>
              <tbody id="satelliteTableBody">
                <tr>
                  <td colspan="7" class="loading">Loading satellite data...</td>
                </tr>
              </tbody>
            </table>

            <div class="pagination">
              <button class="pagination-button" id="firstPage">First</button>
              <button class="pagination-button" id="prevPage">Previous</button>
              <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
              <button class="pagination-button" id="nextPage">Next</button>
              <button class="pagination-button" id="lastPage">Last</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      let allSatellites = [];
      let filteredSatellites = [];
      let currentPage = 1;
      const itemsPerPage = 50;

      // Filter state
      let filters = {
        search: "",
        status: "all",
        type: "all",
        country: "all",
        organization: "all",
        sort: "name",
      };

      // CSV Parser for master list
      function parseCSV(csvText) {
        const lines = csvText.trim().split("\n");
        const headers = lines[0].split(",").map((h) => h.trim());
        const records = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;

          // Simple CSV parsing (handles quoted fields)
          const values = [];
          let currentValue = "";
          let inQuotes = false;

          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === "," && !inQuotes) {
              values.push(currentValue.trim());
              currentValue = "";
            } else {
              currentValue += char;
            }
          }
          values.push(currentValue.trim());

          const record = {};
          headers.forEach((header, index) => {
            record[header] = values[index] || "";
          });
          records.push(record);
        }

        return records;
      }

      // Load and populate table
      async function initializeTableData() {
        try {
          const response = await fetch("../../data/satellite_master_list.csv");
          const csvText = await response.text();
          allSatellites = parseCSV(csvText);
          filteredSatellites = [...allSatellites];

          console.log(`Loaded ${allSatellites.length} satellites`);

          // Populate filter dropdowns
          populateCountryFilter();
          populateOrganizationFilter();

          // Update stats
          updateStats();

          // Initial render
          applyFilters();
        } catch (error) {
          console.error("Error loading satellite table data:", error);
          const tableBody = document.getElementById("satelliteTableBody");
          tableBody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;color:#ff6b6b;">Error loading satellite data</td></tr>';
        }
      }

      // Populate country filter with unique countries (2-3 letter codes)
      function populateCountryFilter() {
        const countries = new Set();
        allSatellites.forEach((sat) => {
          const state = sat.State || sat.Owner;
          if (state && state.trim()) {
            const trimmed = state.trim();
            // Only add if it looks like a country code (2-3 letters, all uppercase)
            if (
              trimmed.length <= 3 &&
              trimmed === trimmed.toUpperCase() &&
              /^[A-Z]+$/.test(trimmed)
            ) {
              countries.add(trimmed);
            }
          }
        });

        const sortedCountries = Array.from(countries).sort();
        const select = document.getElementById("countryFilter");

        sortedCountries.forEach((country) => {
          const option = document.createElement("option");
          option.value = country;
          option.textContent = country;
          select.appendChild(option);
        });
      }

      // Populate organization filter with unique organizations (non-country codes)
      function populateOrganizationFilter() {
        const organizations = new Set();
        allSatellites.forEach((sat) => {
          const orgName = sat.Org_Name;
          if (orgName && orgName.trim() && orgName.trim() !== "-") {
            organizations.add(orgName.trim());
          }
        });

        const sortedOrgs = Array.from(organizations).sort();
        const select = document.getElementById("organizationFilter");

        sortedOrgs.forEach((org) => {
          const option = document.createElement("option");
          option.value = org;
          option.textContent = org;
          select.appendChild(option);
        });
      }

      // Update statistics
      function updateStats() {
        const total = allSatellites.length;
        const active = allSatellites.filter(
          (sat) => sat.STATUS === "ACTIVE"
        ).length;
        const inactive = total - active;

        document.getElementById("totalCount").textContent =
          total.toLocaleString();
        document.getElementById("activeCount").textContent =
          active.toLocaleString();
        document.getElementById("inactiveCount").textContent =
          inactive.toLocaleString();
      }

      // Apply all filters
      function applyFilters() {
        filteredSatellites = allSatellites.filter((sat) => {
          // Search filter
          if (filters.search) {
            const search = filters.search.toLowerCase();
            const name = (sat.Name || "").toLowerCase();
            const norad = (sat.JCAT || "").toString();
            const owner = (sat.Owner || sat.State || "").toLowerCase();

            if (
              !name.includes(search) &&
              !norad.includes(search) &&
              !owner.includes(search)
            ) {
              return false;
            }
          }

          // Status filter
          if (filters.status !== "all" && sat.STATUS !== filters.status) {
            return false;
          }

          // Type filter
          if (filters.type !== "all") {
            const type = (sat.Type || "").trim();
            if (filters.type === "P" && !type.startsWith("P")) return false;
            if (filters.type === "R" && !type.startsWith("R")) return false;
            if (filters.type === "C" && !type.startsWith("C")) return false;
          }

          // Country filter
          if (filters.country !== "all") {
            const state = sat.State || sat.Owner || "";
            if (state.trim() !== filters.country) return false;
          }

          // Organization filter
          if (filters.organization !== "all") {
            const org = sat.Org_Name || "";
            if (org.trim() !== filters.organization) return false;
          }

          return true;
        });

        // Sort
        sortSatellites();

        // Reset to first page
        currentPage = 1;

        // Update UI
        renderTable();
        updatePagination();
        document.getElementById("showingCount").textContent =
          filteredSatellites.length.toLocaleString();
      }

      // Sort satellites
      function sortSatellites() {
        switch (filters.sort) {
          case "name":
            filteredSatellites.sort((a, b) =>
              (a.Name || "").localeCompare(b.Name || "")
            );
            break;
          case "date-desc":
            filteredSatellites.sort((a, b) => {
              const dateA = new Date(a.LDate || "1900-01-01");
              const dateB = new Date(b.LDate || "1900-01-01");
              return dateB - dateA;
            });
            break;
          case "date-asc":
            filteredSatellites.sort((a, b) => {
              const dateA = new Date(a.LDate || "1900-01-01");
              const dateB = new Date(b.LDate || "1900-01-01");
              return dateA - dateB;
            });
            break;
          case "norad":
            filteredSatellites.sort(
              (a, b) => parseInt(a.JCAT || 0) - parseInt(b.JCAT || 0)
            );
            break;
        }
      }

      // Render table with pagination
      function renderTable() {
        const tableBody = document.getElementById("satelliteTableBody");

        if (filteredSatellites.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;color:#999;">No satellites match your filters</td></tr>';
          return;
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(
          startIndex + itemsPerPage,
          filteredSatellites.length
        );
        const pageSatellites = filteredSatellites.slice(startIndex, endIndex);

        const tableHTML = pageSatellites
          .map((sat, index) => {
            const name = sat.Name || "Unknown";
            const norad = sat.JCAT || "N/A";
            const type = getTypeLabel(sat.Type || "");
            const owner = sat.Owner || sat.State || "Unknown";
            const launchDate = formatDate(sat.LDate);
            const status = sat.STATUS || "INACTIVE";
            const dest = sat.Dest || sat.Primary || "Unknown";

            return `
                    <tr onclick="showSatelliteDetail(${
                      startIndex + index
                    })" style="cursor: pointer;">
                        <td><strong>${name}</strong></td>
                        <td>${norad}</td>
                        <td>${type}</td>
                        <td>${owner}</td>
                        <td>${launchDate}</td>
                        <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
                        <td>${dest}</td>
                    </tr>
                `;
          })
          .join("");

        tableBody.innerHTML = tableHTML;
        document.getElementById("satelliteCount").textContent =
          filteredSatellites.length.toLocaleString();
      }

      // Get readable type label
      function getTypeLabel(type) {
        if (!type) return "Unknown";
        if (type.startsWith("P")) return "Payload";
        if (type.startsWith("R")) return "Rocket Body";
        if (type.startsWith("C")) return "Debris";
        return type;
      }

      // Format date
      function formatDate(dateStr) {
        if (!dateStr || dateStr === "-") return "Unknown";
        try {
          // Handle various date formats
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return dateStr;
          return date.toISOString().split("T")[0];
        } catch {
          return dateStr;
        }
      }

      // Update pagination controls
      function updatePagination() {
        const totalPages = Math.ceil(filteredSatellites.length / itemsPerPage);

        document.getElementById(
          "pageInfo"
        ).textContent = `Page ${currentPage} of ${totalPages}`;

        document.getElementById("firstPage").disabled = currentPage === 1;
        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled =
          currentPage === totalPages;
        document.getElementById("lastPage").disabled =
          currentPage === totalPages;
      }

      // Data sanitization helper function
      function sanitizeValue(value, options = {}) {
        if (value === null || value === undefined || value === "") {
          return options.default || "-";
        }

        // Convert to string and trim
        let cleaned = String(value).trim();

        // Remove extra quotes
        cleaned = cleaned.replace(/^["']+|["']+$/g, "");

        // Remove multiple spaces
        cleaned = cleaned.replace(/\s+/g, " ");

        // Handle common placeholder values
        if (
          cleaned === "" ||
          cleaned === "null" ||
          cleaned === "undefined" ||
          cleaned === "N/A" ||
          cleaned === "n/a" ||
          cleaned === "-" ||
          cleaned === "?"
        ) {
          return options.default || "-";
        }

        // Apply unit if provided
        if (options.unit && cleaned !== "-") {
          return `${cleaned} ${options.unit}`;
        }

        // Apply suffix if provided
        if (options.suffix && cleaned !== "-") {
          return `${cleaned}${options.suffix}`;
        }

        return cleaned;
      }

      // Format coordinates
      function formatCoordinates(lat, lon) {
        const cleanLat = sanitizeValue(lat);
        const cleanLon = sanitizeValue(lon);

        if (cleanLat === "-" || cleanLon === "-") {
          return "-";
        }

        return `${cleanLat}°, ${cleanLon}°`;
      }

      // Show comprehensive satellite detail modal
      function showSatelliteDetail(index) {
        const satData = filteredSatellites[index];
        if (!satData) return;

        // Populate modal header
        document.getElementById("modalSatName").textContent = sanitizeValue(
          satData.Name || satData.OBJECT_NAME,
          { default: "Unknown Satellite" }
        );

        // Identification
        document.getElementById("modal_name").textContent = sanitizeValue(
          satData.Name
        );
        document.getElementById("modal_jcat").textContent = sanitizeValue(
          satData.JCAT || satData.NORAD_CAT_ID
        );
        document.getElementById("modal_object_name").textContent =
          sanitizeValue(satData.OBJECT_NAME);
        document.getElementById("modal_launch_tag").textContent = sanitizeValue(
          satData.SatcatLaunch_Tag
        );
        document.getElementById("modal_type").textContent = sanitizeValue(
          satData.Type
        );
        document.getElementById("modal_status").textContent = sanitizeValue(
          satData.STATUS || satData.Status
        );

        // Ownership
        document.getElementById("modal_owner").textContent = sanitizeValue(
          satData.Owner
        );
        document.getElementById("modal_state").textContent = sanitizeValue(
          satData.State
        );
        document.getElementById("modal_org_name").textContent = sanitizeValue(
          satData.Org_Name
        );
        document.getElementById("modal_org_short").textContent = sanitizeValue(
          satData.Org_ShortName
        );
        document.getElementById("modal_org_location").textContent =
          sanitizeValue(satData.Org_Location);
        document.getElementById("modal_org_coords").textContent =
          formatCoordinates(satData.Org_Latitude, satData.Org_Longitude);
        document.getElementById("modal_manufacturer").textContent =
          sanitizeValue(satData.Manufacturer);

        // Launch Information
        document.getElementById("modal_ldate").textContent = sanitizeValue(
          satData.LDate
        );
        document.getElementById("modal_sdate").textContent = sanitizeValue(
          satData.SDate
        );
        document.getElementById("modal_odate").textContent = sanitizeValue(
          satData.ODate
        );
        document.getElementById("modal_ddate").textContent = sanitizeValue(
          satData.DDate
        );
        document.getElementById("modal_primary").textContent = sanitizeValue(
          satData.Primary
        );

        // Orbital Parameters
        document.getElementById("modal_perigee").textContent = sanitizeValue(
          satData.Perigee,
          { unit: "km" }
        );
        document.getElementById("modal_apogee").textContent = sanitizeValue(
          satData.Apogee,
          { unit: "km" }
        );
        document.getElementById("modal_inclination").textContent =
          sanitizeValue(satData.INCLINATION || satData.Inc, { suffix: "°" });
        document.getElementById("modal_eccentricity").textContent =
          sanitizeValue(satData.ECCENTRICITY);
        document.getElementById("modal_mean_motion").textContent =
          sanitizeValue(satData.MEAN_MOTION, { unit: "rev/day" });
        document.getElementById("modal_epoch").textContent = sanitizeValue(
          satData.EPOCH
        );
        document.getElementById("modal_rev_epoch").textContent = sanitizeValue(
          satData.REV_AT_EPOCH
        );

        // Physical Characteristics
        document.getElementById("modal_mass").textContent = sanitizeValue(
          satData.Mass,
          { unit: "kg" }
        );
        document.getElementById("modal_drymass").textContent = sanitizeValue(
          satData.DryMass,
          { unit: "kg" }
        );
        document.getElementById("modal_totmass").textContent = sanitizeValue(
          satData.TotMass,
          { unit: "kg" }
        );
        document.getElementById("modal_length").textContent = sanitizeValue(
          satData.Length,
          { unit: "m" }
        );
        document.getElementById("modal_diameter").textContent = sanitizeValue(
          satData.Diamete,
          { unit: "m" }
        );
        document.getElementById("modal_span").textContent = sanitizeValue(
          satData.Span,
          { unit: "m" }
        );
        document.getElementById("modal_shape").textContent = sanitizeValue(
          satData.Shape
        );

        // Advanced Orbital Data
        document.getElementById("modal_ra_node").textContent = sanitizeValue(
          satData.RA_OF_ASC_NODE,
          { suffix: "°" }
        );
        document.getElementById("modal_arg_peri").textContent = sanitizeValue(
          satData.ARG_OF_PERICENTER,
          { suffix: "°" }
        );
        document.getElementById("modal_mean_anomaly").textContent =
          sanitizeValue(satData.MEAN_ANOMALY, { suffix: "°" });
        document.getElementById("modal_bstar").textContent = sanitizeValue(
          satData.BSTAR
        );
        document.getElementById("modal_mm_dot").textContent = sanitizeValue(
          satData.MEAN_MOTION_DOT
        );
        document.getElementById("modal_mm_ddot").textContent = sanitizeValue(
          satData.MEAN_MOTION_DDOT
        );
        document.getElementById("modal_element_set").textContent =
          sanitizeValue(satData.ELEMENT_SET_NO);

        // TLE Data (if available)
        const tleFetched = satData.TLE_FETCHED === "YES";
        const tleSection = document.getElementById("tleSection");

        if (tleFetched) {
          tleSection.style.display = "block";
          document.getElementById("modal_tle_fetched").textContent = "✓ Yes";
          document.getElementById("modal_n2yo_name").textContent =
            sanitizeValue(satData.N2YO_SAT_NAME);
          document.getElementById("modal_tle_line1").textContent =
            sanitizeValue(satData.TLE_LINE1);
          document.getElementById("modal_tle_line2").textContent =
            sanitizeValue(satData.TLE_LINE2);
        } else {
          tleSection.style.display = "none";
        }

        // Show modal
        document.getElementById("detailModal").classList.add("active");
      }

      // Close detail modal
      function closeDetailModal() {
        document.getElementById("detailModal").classList.remove("active");
      }

      // ESC key to close modal
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeDetailModal();
        }
      });

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        initializeTableData();

        // Search
        document
          .getElementById("registrySearch")
          .addEventListener("input", function (e) {
            filters.search = e.target.value;
            applyFilters();
          });

        // Status filters
        document
          .querySelectorAll(".filter-button[data-status]")
          .forEach((button) => {
            button.addEventListener("click", function () {
              document
                .querySelectorAll(".filter-button[data-status]")
                .forEach((b) => b.classList.remove("active"));
              this.classList.add("active");
              filters.status = this.dataset.status;
              applyFilters();
            });
          });

        // Type filters
        document
          .querySelectorAll(".filter-button[data-type]")
          .forEach((button) => {
            button.addEventListener("click", function () {
              document
                .querySelectorAll(".filter-button[data-type]")
                .forEach((b) => b.classList.remove("active"));
              this.classList.add("active");
              filters.type = this.dataset.type;
              applyFilters();
            });
          });

        // Country filter
        document
          .getElementById("countryFilter")
          .addEventListener("change", function () {
            filters.country = this.value;
            applyFilters();
          });

        // Organization filter
        document
          .getElementById("organizationFilter")
          .addEventListener("change", function () {
            filters.organization = this.value;
            applyFilters();
          });

        // Sort filter
        document
          .getElementById("sortFilter")
          .addEventListener("change", function () {
            filters.sort = this.value;
            applyFilters();
          });

        // Pagination
        document.getElementById("firstPage").addEventListener("click", () => {
          currentPage = 1;
          renderTable();
          updatePagination();
        });

        document.getElementById("prevPage").addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable();
            updatePagination();
          }
        });

        document.getElementById("nextPage").addEventListener("click", () => {
          const totalPages = Math.ceil(
            filteredSatellites.length / itemsPerPage
          );
          if (currentPage < totalPages) {
            currentPage++;
            renderTable();
            updatePagination();
          }
        });

        document.getElementById("lastPage").addEventListener("click", () => {
          currentPage = Math.ceil(filteredSatellites.length / itemsPerPage);
          renderTable();
          updatePagination();
        });
      });
    </script>

    <!-- Comprehensive Satellite Detail Modal (same HTML as tracker_v2.html) -->
    <div class="detail-modal" id="detailModal">
      <div class="detail-modal-content">
        <div class="detail-modal-header">
          <h2 id="modalSatName">Satellite Details</h2>
          <button class="detail-modal-close" onclick="closeDetailModal()">
            ×
          </button>
        </div>

        <div class="detail-sections">
          <!-- Identification Section -->
          <div class="detail-section">
            <h3>🛰️ Identification</h3>
            <div class="detail-row">
              <span class="detail-row-label">Name</span>
              <span class="detail-row-value" id="modal_name">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">NORAD Cat ID</span>
              <span class="detail-row-value" id="modal_jcat">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Object Name</span>
              <span class="detail-row-value" id="modal_object_name">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Launch Tag</span>
              <span class="detail-row-value" id="modal_launch_tag">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Type</span>
              <span class="detail-row-value" id="modal_type">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Status</span>
              <span class="detail-row-value" id="modal_status">-</span>
            </div>
          </div>

          <!-- Ownership Section -->
          <div class="detail-section">
            <h3>🌍 Ownership & Origin</h3>
            <div class="detail-row">
              <span class="detail-row-label">Owner Code</span>
              <span class="detail-row-value" id="modal_owner">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">State</span>
              <span class="detail-row-value" id="modal_state">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Organization</span>
              <span class="detail-row-value" id="modal_org_name">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Organization (Short)</span>
              <span class="detail-row-value" id="modal_org_short">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Location</span>
              <span class="detail-row-value" id="modal_org_location">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Coordinates</span>
              <span class="detail-row-value" id="modal_org_coords">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Manufacturer</span>
              <span class="detail-row-value" id="modal_manufacturer">-</span>
            </div>
          </div>

          <!-- Launch Information -->
          <div class="detail-section">
            <h3>🚀 Launch Information</h3>
            <div class="detail-row">
              <span class="detail-row-label">Launch Date</span>
              <span class="detail-row-value" id="modal_ldate">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Site Date</span>
              <span class="detail-row-value" id="modal_sdate">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Operational Date</span>
              <span class="detail-row-value" id="modal_odate">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Decay Date</span>
              <span class="detail-row-value" id="modal_ddate">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Primary</span>
              <span class="detail-row-value" id="modal_primary">-</span>
            </div>
          </div>

          <!-- Orbital Parameters -->
          <div class="detail-section">
            <h3>🌌 Orbital Parameters</h3>
            <div class="detail-row">
              <span class="detail-row-label">Perigee</span>
              <span class="detail-row-value" id="modal_perigee">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Apogee</span>
              <span class="detail-row-value" id="modal_apogee">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Inclination</span>
              <span class="detail-row-value" id="modal_inclination">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Eccentricity</span>
              <span class="detail-row-value" id="modal_eccentricity">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Mean Motion</span>
              <span class="detail-row-value" id="modal_mean_motion">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Epoch</span>
              <span class="detail-row-value" id="modal_epoch">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Rev at Epoch</span>
              <span class="detail-row-value" id="modal_rev_epoch">-</span>
            </div>
          </div>

          <!-- Physical Characteristics -->
          <div class="detail-section">
            <h3>⚙️ Physical Characteristics</h3>
            <div class="detail-row">
              <span class="detail-row-label">Mass</span>
              <span class="detail-row-value" id="modal_mass">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Dry Mass</span>
              <span class="detail-row-value" id="modal_drymass">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Total Mass</span>
              <span class="detail-row-value" id="modal_totmass">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Length</span>
              <span class="detail-row-value" id="modal_length">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Diameter</span>
              <span class="detail-row-value" id="modal_diameter">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Span</span>
              <span class="detail-row-value" id="modal_span">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Shape</span>
              <span class="detail-row-value" id="modal_shape">-</span>
            </div>
          </div>

          <!-- Advanced Orbital Data -->
          <div class="detail-section">
            <h3>📊 Advanced Orbital Data</h3>
            <div class="detail-row">
              <span class="detail-row-label">RA of Asc Node</span>
              <span class="detail-row-value" id="modal_ra_node">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Arg of Pericenter</span>
              <span class="detail-row-value" id="modal_arg_peri">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Mean Anomaly</span>
              <span class="detail-row-value" id="modal_mean_anomaly">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">BSTAR</span>
              <span class="detail-row-value" id="modal_bstar">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Mean Motion Dot</span>
              <span class="detail-row-value" id="modal_mm_dot">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Mean Motion DDot</span>
              <span class="detail-row-value" id="modal_mm_ddot">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">Element Set No</span>
              <span class="detail-row-value" id="modal_element_set">-</span>
            </div>
          </div>

          <!-- TLE Data Section -->
          <div
            class="detail-section tle-section"
            id="tleSection"
            style="display: none"
          >
            <h3>📡 Two-Line Element Set (TLE)</h3>
            <div class="detail-row">
              <span class="detail-row-label">TLE Available</span>
              <span class="detail-row-value" id="modal_tle_fetched">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-row-label">N2YO Satellite Name</span>
              <span class="detail-row-value" id="modal_n2yo_name">-</span>
            </div>
            <div style="margin-top: 1rem">
              <div class="detail-row-label" style="margin-bottom: 0.5rem">
                Line 1:
              </div>
              <div class="tle-line" id="modal_tle_line1">-</div>
            </div>
            <div style="margin-top: 1rem">
              <div class="detail-row-label" style="margin-bottom: 0.5rem">
                Line 2:
              </div>
              <div class="tle-line" id="modal_tle_line2">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
